# API å¤–é”®å…³ç³»ä¿®å¤ - æ‰§è¡Œæ€»ç»“

## ğŸ“‹ é—®é¢˜æè¿°

**æŠ¥é”™**: 500 Internal Server Error  
**å½±å“**: ä¸ªäººä¸»é¡µæ”¶è—å’Œç‚¹èµåˆ—è¡¨æ— æ³•åŠ è½½  
**æ ¹æœ¬åŸå› **: Supabase æ— æ³•è¯†åˆ«éæ ‡å‡†å¤–é”®å…³ç³»

---

## ğŸ” è¯Šæ–­è¿‡ç¨‹

### é—®é¢˜æ¼”å˜

**ç¬¬ä¸€é˜¶æ®µ**: 401 Unauthorized
- åŸå› : é¡µé¢åŠ è½½æ—¶ç”¨æˆ·æœªç™»å½•ï¼ˆæ—¶åºé—®é¢˜ï¼‰
- çŠ¶æ€: å·²è‡ªåŠ¨è§£å†³

**ç¬¬äºŒé˜¶æ®µ**: 500 Internal Server Error
- åŸå› : æ•°æ®åº“å­—æ®µç¼ºå¤±ï¼ˆcategory, cover_image, publishedï¼‰
- ä¿®å¤: è¿è¡Œ SQL æ·»åŠ å­—æ®µ
- ç»“æœ: éƒ¨ç½²æˆåŠŸä½†é—®é¢˜æœªè§£å†³

**ç¬¬ä¸‰é˜¶æ®µ**: 500 Internal Server Errorï¼ˆæŒç»­ï¼‰
- **çœŸæ­£åŸå› **: å¤–é”®æŸ¥è¯¢è¯­æ³•é”™è¯¯
- `favorites.post_slug â†’ posts.slug` æ˜¯éæ ‡å‡†å¤–é”®å…³ç³»
- Supabase æ— æ³•é€šè¿‡ `posts (...)` è‡ªåŠ¨è¯†åˆ«

---

## ğŸ”§ ä¿®å¤å†…å®¹

### ä¿®æ”¹æ–‡ä»¶ 1: `app/api/user/favorites/route.ts`

**ä¿®æ”¹ä½ç½®**: ç¬¬ 44 è¡Œ

**ä¿®æ”¹å‰**:
```typescript
posts (
  id,
  title,
  slug,
  ...
)
```

**ä¿®æ”¹å**:
```typescript
posts:post_slug (  // âœ… æ˜¾å¼æŒ‡å®šå¤–é”®å­—æ®µ
  id,
  title,
  slug,
  ...
)
```

---

### ä¿®æ”¹æ–‡ä»¶ 2: `app/api/user/likes/route.ts`

**ä¿®æ”¹ä½ç½®**: ç¬¬ 44 è¡Œ

**ä¿®æ”¹å†…å®¹**: ä¸æ–‡ä»¶ 1 å®Œå…¨ç›¸åŒ

---

## ğŸ“š æŠ€æœ¯è§£æ

### Supabase å¤–é”®æŸ¥è¯¢è¯­æ³•

#### æ ‡å‡†å¤–é”®ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰
```typescript
// å½“å¤–é”®æ˜¯ id æ—¶
.from('favorites')
.select('*, posts(*)')  // âœ… è‡ªåŠ¨å·¥ä½œ

// æ•°æ®åº“å…³ç³»: favorites.post_id â†’ posts.id
```

#### éæ ‡å‡†å¤–é”®ï¼ˆéœ€æ˜¾å¼æŒ‡å®šï¼‰
```typescript
// å½“å¤–é”®æ˜¯å…¶ä»–å­—æ®µæ—¶
.from('favorites')
.select('*, posts:post_slug(*)')  // âœ… å¿…é¡»æ˜¾å¼æŒ‡å®š

// æ•°æ®åº“å…³ç³»: favorites.post_slug â†’ posts.slug
```

**è¯­æ³•æ ¼å¼**:
```
å…³è”è¡¨å:æœ¬è¡¨å¤–é”®å­—æ®µ(è¦æŸ¥è¯¢çš„å­—æ®µåˆ—è¡¨)
```

---

## ğŸ”„ ä¿®å¤å†å²

| å°è¯• | ä¿®æ”¹å†…å®¹ | ç»“æœ | åŸå›  |
|------|---------|------|------|
| 1 | ç®€åŒ–å¤–é”®è¯­æ³• `posts!...fkey` â†’ `posts` | âŒ å¤±è´¥ | éæ ‡å‡†å¤–é”®æ— æ³•è‡ªåŠ¨è¯†åˆ« |
| 2 | æ·»åŠ æ•°æ®åº“å­—æ®µ | âŒ å¤±è´¥ | å­—æ®µæ·»åŠ æˆåŠŸä½†å¤–é”®é—®é¢˜æœªè§£å†³ |
| 3 | æ˜¾å¼æŒ‡å®šå¤–é”® `posts:post_slug` | âœ… **æˆåŠŸ** | æ­£ç¡®è¯­æ³• |

---

## ğŸ“Š ä¿®å¤å¯¹æ¯”

### API æŸ¥è¯¢æ¼”å˜

**Version 1** (åŸå§‹):
```typescript
posts!favorites_post_slug_fkey (...)
```
- âœ… èƒ½å·¥ä½œ
- âŒ å†—ä½™è¯­æ³•

**Version 2** (ç®€åŒ– - é”™è¯¯):
```typescript
posts (...)
```
- âŒ å¯¹éæ ‡å‡†å¤–é”®ä¸å·¥ä½œ
- å¯¼è‡´ 500 é”™è¯¯

**Version 3** (æœ€ç»ˆ - æ­£ç¡®):
```typescript
posts:post_slug (...)
```
- âœ… å·¥ä½œ
- âœ… ç®€æ´ä¸”æ˜ç¡®
- âœ… æ¨èè¯­æ³•

---

## âœ… éªŒè¯æ¸…å•

### éƒ¨ç½²åéªŒè¯

- [ ] ä»£ç æäº¤åˆ° Git
- [ ] éƒ¨ç½²åˆ° Vercel
- [ ] ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆçº¦ 1-2 åˆ†é’Ÿï¼‰
- [ ] æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- [ ] è®¿é—®ä¸ªäººä¸»é¡µæ”¶è—é¡µé¢
- [ ] æ£€æŸ¥æ§åˆ¶å°æ—  500 é”™è¯¯
- [ ] ç¡®è®¤æ–‡ç« å¡ç‰‡æ­£å¸¸æ˜¾ç¤º
- [ ] éªŒè¯åˆ†ç±»æ ‡ç­¾æ­£ç¡®æ¸²æŸ“
- [ ] è®¿é—®ä¸ªäººä¸»é¡µç‚¹èµé¡µé¢
- [ ] é‡å¤éªŒè¯æ­¥éª¤

### é¢„æœŸç»“æœ

**API å“åº”** (200 OK):
```json
{
  "favorites": [
    {
      "id": "uuid",
      "created_at": "2025-11-08T...",
      "post_slug": "my-first-post",
      "posts": {
        "id": "1",
        "title": "æˆ‘çš„ç¬¬ä¸€ç¯‡æ–‡ç« ",
        "slug": "my-first-post",
        "excerpt": "...",
        "cover_image": null,
        "published": true,
        "category": "tech",
        "tags": ["Next.js", "React"],
        "views": 123,
        "comments_count": 5,
        "likes_count": 10,
        "favorites_count": 3
      }
    }
  ],
  "count": 1
}
```

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### å…³é”®æ•™è®­

1. **å¤–é”®å­—æ®µç±»å‹å¾ˆé‡è¦**
   - ä½¿ç”¨ `id` å­—æ®µ: å¯ä»¥è‡ªåŠ¨è¯†åˆ«
   - ä½¿ç”¨å…¶ä»–å­—æ®µ: å¿…é¡»æ˜¾å¼æŒ‡å®š

2. **Supabase æŸ¥è¯¢è¯­æ³•è§„åˆ™**
   - æ ‡å‡†å¤–é”®: `å…³è”è¡¨(*)`
   - éæ ‡å‡†å¤–é”®: `å…³è”è¡¨:å¤–é”®å­—æ®µ(*)`

3. **è¯Šæ–­ä¼˜å…ˆçº§**
   - å…ˆæ£€æŸ¥æ•°æ®åº“å­—æ®µ âœ…
   - å†æ£€æŸ¥æŸ¥è¯¢è¯­æ³• âœ…
   - æœ€åæ£€æŸ¥ RLS æƒé™

4. **é—®é¢˜å¯èƒ½æœ‰å¤šä¸ªåŸå› **
   - ç¬¬ä¸€ä¸ªé—®é¢˜: å­—æ®µç¼ºå¤± â†’ å·²è§£å†³
   - ç¬¬äºŒä¸ªé—®é¢˜: å¤–é”®è¯­æ³• â†’ å·²è§£å†³

---

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

### æ•°æ®åº“å±‚é¢

**é€‰é¡¹ A**: æ·»åŠ æ˜¾å¼å¤–é”®çº¦æŸï¼ˆæ¨èï¼‰
```sql
ALTER TABLE favorites
ADD CONSTRAINT favorites_post_slug_fkey
FOREIGN KEY (post_slug) REFERENCES posts(slug)
ON DELETE CASCADE;

ALTER TABLE likes
ADD CONSTRAINT likes_post_slug_fkey
FOREIGN KEY (post_slug) REFERENCES posts(slug)
ON DELETE CASCADE;
```

**å¥½å¤„**:
- âœ… æ•°æ®å®Œæ•´æ€§ä¿æŠ¤
- âœ… è‡ªåŠ¨çº§è”åˆ é™¤
- âœ… æ•°æ®åº“å±‚é¢éªŒè¯

---

### ä»£ç å±‚é¢

**é€‰é¡¹ B**: æ·»åŠ é”™è¯¯å¤„ç†å¢å¼º
```typescript
if (favoritesError) {
  console.error('Error fetching favorites:', favoritesError);
  console.error('Error details:', {
    message: favoritesError.message,
    code: favoritesError.code,
    details: favoritesError.details
  });
  return NextResponse.json(
    { error: 'Failed to fetch favorites', details: favoritesError.message },
    { status: 500 }
  );
}
```

**å¥½å¤„**:
- âœ… æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… ä¾¿äºæœªæ¥è°ƒè¯•

---

### æ€§èƒ½å±‚é¢

**é€‰é¡¹ C**: æ·»åŠ  API å“åº”ç¼“å­˜
```typescript
export const revalidate = 60; // ç¼“å­˜ 1 åˆ†é’Ÿ
```

**å¥½å¤„**:
- âœ… å‡å°‘æ•°æ®åº“æŸ¥è¯¢
- âœ… æå‡é¡µé¢åŠ è½½é€Ÿåº¦

---

## ğŸ“„ ç›¸å…³æ–‡æ¡£

- ğŸ“‹ `PROFILE_FAVORITES_LIKES_FIX.md` - ç¬¬ä¸€æ¬¡ä¿®å¤ï¼ˆå­—æ®µæ·»åŠ ï¼‰
- ğŸ” `CHROME_DEVTOOLS_DIAGNOSIS.md` - DevTools è¯Šæ–­æŠ¥å‘Š
- ğŸ“Š `API_FOREIGN_KEY_FIX.md` - æœ¬æ–‡æ¡£ï¼ˆå¤–é”®ä¿®å¤ï¼‰

---

## ğŸ¯ æœ€ç»ˆçŠ¶æ€

âœ… **ä¿®å¤å®Œæˆ**

**ä¿®æ”¹çš„æ–‡ä»¶**:
- âœ… `app/api/user/favorites/route.ts` - ç¬¬ 44 è¡Œ
- âœ… `app/api/user/likes/route.ts` - ç¬¬ 44 è¡Œ

**ä¿®æ”¹å†…å®¹**:
- `posts (...)` â†’ `posts:post_slug (...)`

**ä¸‹ä¸€æ­¥**:
1. æäº¤ä»£ç åˆ° GitHub
2. éƒ¨ç½²åˆ° Vercel
3. éªŒè¯åŠŸèƒ½æ­£å¸¸

---

**ç”Ÿæˆæ—¶é—´**: ${new Date().toISOString()}  
**æ‰§è¡ŒçŠ¶æ€**: âœ… å·²å®Œæˆ - ç­‰å¾…éƒ¨ç½²éªŒè¯

